@implements IDisposable
@using MothsOath.Core.Entities.Archetypes
@using MothsOath.Core.StatusEffect.DiseaseEffect

<div class="combat-container" @onclick="CancelSelection">
    <div class="enemy-area">
        @foreach (var enemy in CombatState.Enemies)
        {
            <div class="@(GetEnemyCardClass(enemy))"
                 @onclick="() => TargetEnemy(enemy)" @onclick:stopPropagation="true"
                 @onmouseover="() => OnEnemyHover(enemy)"
                 @onmouseout="() => OnEnemyOut(enemy)">
                <p>@enemy.Name</p>
                <p>HP: @enemy.Stats.CurrentHealth / @enemy.Stats.MaxHealth</p>
            </div>
        }
    </div>

    <div class="player-area">
        <div class="player-display-area">
            <div class="@(GetPlayerCardClass())"
                 @onclick="() => TargetPlayer()" @onclick:stopPropagation="true"
                 @onmouseover="OnPlayerHover"
                 @onmouseout="OnPlayerOut">
                <p class="player-name">@CombatState.Player.Name</p>
                <p class="player-hp">HP: @CombatState.Player.Stats.CurrentHealth / @CombatState.Player.Stats.MaxHealth</p>
        </div>
        @if (CombatState.Player is Doctor)
        {
            <div class="doctor-hud">
                <button class="doctor-hud-btn btn btn-secondary" @onclick="ShowDisease" @onclick:stopPropagation="true">Exibir Patogeno</button>
                <button class="doctor-hud-btn btn btn-danger" disabled="@(CombatState.Player.CurrentMana < 50 || CombatState.Player.Gold < 10)" @onclick="ToggleInfect" @onclick:stopPropagation="true">Infectar</button>
            </div>
        }
        </div>
        <div class="player-hand-container">
            @if (selectedCard == null  && !examining)
            {
                <div class="hand">
                    @foreach (var card in CombatState.Player.Hand)
                    {
                        <div @onclick="() => SelectCard(card)" @onclick:stopPropagation="true">
                            <CardComponent CardData="card" />
                        </div>
                    }
                </div>
            }
        </div>
        <div class="player-actions">
            <button @onclick="EndTurnClicked" @onclick:stopPropagation="true">Finalizar Turno</button>           
            <button @onclick="ExamineClicked" @onclick:stopPropagation="true">Examinar</button>
        </div>
    </div>

    </div> <ExaminateModal @ref="examinateModal" CharacterProfile="itemToExamine" OnClose="OnModalClosed" />

@code {
    private ExaminateModal? examinateModal;
    private Character? itemToExamine;

    [Parameter]
    public CombatState CombatState { get; set; } = default!;

    private BaseCard? selectedCard;
    private Enemy? hoveredEnemy;
    private bool isPlayerHovered;
    private bool examining = false;
    private bool infecting = false;
    private DoctorDiseaseModal? doctorDiseaseModal;

    protected override void OnInitialized()
    {
        CombatState.OnCombatStateChanged += OnCombatStateChanged;
    }

    private void OnCombatStateChanged()
    {
        InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        if (CombatState != null)
        {
            CombatState.OnCombatStateChanged -= OnCombatStateChanged;
        }
    }

    private void CancelSelection()
    {
        selectedCard = null;
        hoveredEnemy = null;
        isPlayerHovered = false;
        examining = false;
        StateHasChanged();
    }

    private void OnModalClosed()
    {
        itemToExamine = null;
        examining = false;
        StateHasChanged();
    }

    private void ShowDisease()
    {
        if (CombatState.Player is Doctor doctor && doctorDiseaseModal != null)
        {
            doctorDiseaseModal.OpenModal(doctor.Disease);
        }
    }

    private void ToggleInfect()
    {
        if (CombatState.Player.CurrentMana < 50 || CombatState.Player.Gold < 10)
        {
            return;
        }

        infecting = !infecting;
        StateHasChanged();
    }

    private void EndTurnClicked()
    {
        CombatState.EndPlayerTurn();
    }

    private void ExamineClicked()
    {
        examining = !examining;
        StateHasChanged();
    }

    private void SelectCard(BaseCard card)
    {
        selectedCard = card;
        StateHasChanged();
    }

    private void TargetEnemy(Enemy enemy)
    {
        if (selectedCard != null)
        {
            CombatState.PlayCard(selectedCard, enemy);
            selectedCard = null;
            hoveredEnemy = null;
            isPlayerHovered = false;
            StateHasChanged();
        }
        else if(examining)
        {
            itemToExamine = enemy;
            if (examinateModal != null)
            {
                examinateModal.OpenModal(itemToExamine);
            }
        }
        else if (infecting)
        {
            if (CombatState.Player is Doctor doctor)
            {
                if (CombatState.Player.CurrentMana < 50 || CombatState.Player.Gold < 10)
                {
                    infecting = false;
                    StateHasChanged();
                    return;
                }

                // pay costs
                CombatState.Player.CurrentMana -= 50;
                CombatState.Player.Gold -= 10;

                doctor.Infect(enemy);
            }

            infecting = false;
            StateHasChanged();
        }
    }

    private void TargetPlayer()
    {
        if (selectedCard != null)
        {
            CombatState.PlayCard(selectedCard, CombatState.Player);
            selectedCard = null;
            hoveredEnemy = null;
            isPlayerHovered = false;
            StateHasChanged();
        }
        else if(examining)
        {
            itemToExamine = CombatState.Player;
            if (examinateModal != null)
            {
                examinateModal.OpenModal(itemToExamine);
            }
        }
        else if (infecting)
        {
            if (CombatState.Player is Doctor doctor)
            {
                if (CombatState.Player.CurrentMana <= 50 || CombatState.Player.Gold <= 10)
                {
                    infecting = false;
                    StateHasChanged();
                    return;
                }

                doctor.Infect(CombatState.Player);
            }

            infecting = false;
            StateHasChanged();
        }
    }

    private void OnEnemyHover(Enemy enemy)
    {
        if (selectedCard != null || infecting)
        {
            hoveredEnemy = enemy;
            StateHasChanged();
        }
    }

    private void OnEnemyOut(Enemy enemy)
    {
        if (hoveredEnemy == enemy)
        {
            hoveredEnemy = null;
            StateHasChanged();
        }
    }

    private void OnPlayerHover()
    {
        if (selectedCard != null || infecting)
        {
            isPlayerHovered = true;
            StateHasChanged();
        }
    }

    private void OnPlayerOut()
    {
        if (isPlayerHovered)
        {
            isPlayerHovered = false;
            StateHasChanged();
        }
    }

    private string GetPlayerCardClass()
    {
        var classes = "player-card";
        if (selectedCard != null || infecting)
        {
            classes += " selectable";
        }
        if (isPlayerHovered && (selectedCard != null || infecting))
        {
            classes += " hovered";
        }
        return classes;
    }

    private string GetEnemyCardClass(Enemy enemy)
    {
        var classes = "enemy-card";
        if (selectedCard != null || infecting)
        {
            classes += " selectable";
        }
        if (hoveredEnemy == enemy && (selectedCard != null || infecting))
        {
            classes += " hovered";
        }
        return classes;
    }
}

<DoctorDiseaseModal @ref="doctorDiseaseModal" />

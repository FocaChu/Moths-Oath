@implements IDisposable

<div class="combat-container" @onclick="CancelSelection">
    <div class="enemy-area">
        @foreach (var enemy in CombatState.Enemies)
        {
            <div class="@(GetEnemyCardClass(enemy))"
                 @onclick="() => TargetEnemy(enemy)" @onclick:stopPropagation="true"
                 @onmouseover="() => OnEnemyHover(enemy)"
                 @onmouseout="() => OnEnemyOut(enemy)">
                <p>@enemy.Name</p>
                <p>HP: @enemy.CurrentHealth / @enemy.MaxHealth</p>
            </div>
        }
    </div>

    <div class="player-area">
        <div class="player-display-area">
            <div class="@(GetPlayerCardClass())"
                 @onclick="() => TargetPlayer()" @onclick:stopPropagation="true"
                 @onmouseover="OnPlayerHover"
                 @onmouseout="OnPlayerOut">
                <p class="player-name">@CombatState.Player.Name</p>
                <p class="player-hp">HP: @CombatState.Player.CurrentHealth / @CombatState.Player.MaxHealth</p>
            </div>
        </div>
        <div class="player-hand-container">
            @if (selectedCard == null)
            {
                <div class="hand">
                    @foreach (var card in CombatState.Player.Hand)
                    {
                        <div @onclick="() => SelectCard(card)" @onclick:stopPropagation="true">
                            <CardComponent CardData="card" />
                        </div>
                    }
                </div>
            }
        </div>
        <div class="player-actions">
            <button @onclick="EndTurnClicked" @onclick:stopPropagation="true">Finalizar Turno</button>
        </div>
    </div>
</div>

@code {
    [Parameter]
    public CombatState CombatState { get; set; }

    private BaseCard? selectedCard;
    private Enemy? hoveredEnemy;
    private bool isPlayerHovered;

    protected override void OnInitialized()
    {
        CombatState.OnCombatStateChanged += OnCombatStateChanged;
    }

    private void OnCombatStateChanged()
    {
        InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        if (CombatState != null)
        {
            CombatState.OnCombatStateChanged -= OnCombatStateChanged;
        }
    }

    private void CancelSelection()
    {
        selectedCard = null;
        hoveredEnemy = null;
        isPlayerHovered = false;
        StateHasChanged();
    }

    private void EndTurnClicked()
    {
        CombatState.EndPlayerTurn();
    }

    private void SelectCard(BaseCard card)
    {
        selectedCard = card;
        StateHasChanged();
    }

    private void TargetEnemy(Enemy enemy)
    {
        if (selectedCard != null)
        {
            CombatState.PlayCard(selectedCard, enemy);
            selectedCard = null;
            hoveredEnemy = null;
            isPlayerHovered = false;
            StateHasChanged();
        }
    }

    private void TargetPlayer()
    {
        if (selectedCard != null)
        {
            CombatState.PlayCard(selectedCard, CombatState.Player);
            selectedCard = null;
            hoveredEnemy = null;
            isPlayerHovered = false;
            StateHasChanged();
        }
    }

    private void OnEnemyHover(Enemy enemy)
    {
        if (selectedCard != null)
        {
            hoveredEnemy = enemy;
            StateHasChanged();
        }
    }

    private void OnEnemyOut(Enemy enemy)
    {
        if (hoveredEnemy == enemy)
        {
            hoveredEnemy = null;
            StateHasChanged();
        }
    }

    private void OnPlayerHover()
    {
        if (selectedCard != null)
        {
            isPlayerHovered = true;
            StateHasChanged();
        }
    }

    private void OnPlayerOut()
    {
        if (isPlayerHovered)
        {
            isPlayerHovered = false;
            StateHasChanged();
        }
    }

    private string GetPlayerCardClass()
    {
        var classes = "player-card";
        if (selectedCard != null)
        {
            classes += " selectable";
        }
        if (isPlayerHovered && selectedCard != null)
        {
            classes += " hovered";
        }
        return classes;
    }

    private string GetEnemyCardClass(Enemy enemy)
    {
        var classes = "enemy-card";
        if (selectedCard != null)
        {
            classes += " selectable";
        }
        if (hoveredEnemy == enemy && selectedCard != null)
        {
            classes += " hovered";
        }
        return classes;
    }
}

@implements IDisposable
@using MothsOath.Core.Entities.Archetypes
@using MothsOath.UI.Components.ArchetypesCombatUI
@using MothsOath.Core.Models.Enums

<div class="combat-container" @onclick="CancelSelection">
    <div class="enemy-area">
        @foreach (var enemy in CombatState.Enemies)
        {
            <div class="@(GetEnemyCardClass(enemy))"
                 @onclick="() => TargetCharacter(enemy)" @onclick:stopPropagation="true"
                 @onmouseover="() => OnEnemyHover(enemy)"
                 @onmouseout="() => OnEnemyOut(enemy)">
                <p>@enemy.Name</p>
                <p>HP: @enemy.Stats.CurrentHealth / @enemy.Stats.MaxHealth</p>
            </div>
        }
    </div>

    <div class="player-area">
        <div class="player-display-area">
            <div class="player-team">
                @foreach (var c in CombatState.BuildPlayerTeam())
                {
                    var isPlayer = c == CombatState.Player;
                    if (isPlayer)
                    {
                        <div class="@GetPlayerCardClass()"
                     @onclick="() => TargetCharacter(c)" @onclick:stopPropagation="true"
                     @onmouseover="() => { OnPlayerHover(); }"
                     @onmouseout="() => { OnPlayerOut(); }">
                            <p class="player-name">@c.Name</p>
                            <p class="player-hp">HP: @c.Stats.CurrentHealth / @c.Stats.MaxHealth</p>
                        </div>
                    }
                    else
                    {
                        <div class="@GetAllyCardClass(c)"
                             @onclick="() => TargetCharacter(c)" @onclick:stopPropagation="true"
                             @onmouseover="() => OnAllyHover(c)"
                             @onmouseout="() => OnAllyOut(c)">
                            <p class="player-name">@c.Name</p>
                            <p class="player-hp">HP: @c.Stats.CurrentHealth / @c.Stats.MaxHealth</p>
                        </div>
                    }
                }
            </div>
        </div>
        <div class="player-hand-container">
            @if (selectedCard == null && !examining)
            {
                <div class="hand">
                    @foreach (var card in CombatState.Player.Hand)
                    {
                        <div @onclick="() => SelectCard(card)" @onclick:stopPropagation="true">
                            <CardComponent CardData="card" />
                        </div>
                    }
                </div>
            }
        </div>
        <div class="player-actions">
            <div class="action-buttons">
                <button @onclick="EndTurnClicked" @onclick:stopPropagation="true">Finalizar Turno</button>
                <button @onclick="ExamineClicked" @onclick:stopPropagation="true">Examinar</button>
            </div>

            <div class="archetype-hud-container">
                @if (CombatState.Player is Doctor)
                {
                    <DoctorCombatUI @ref="doctorCombatUI"
                                    CombatState="CombatState"
                                    OnTargetCharacter="OnArchetypeTargetCharacter"
                                    OnCancelSelection="CancelSelection" />
                }
                else if (CombatState.Player is BellRinger)
                {
                    <BellRingerCombatUI @ref="bellRingerCombatUI"
                                         CombatState="CombatState"
                                         OnTargetCharacter="OnArchetypeTargetCharacter"
                                         OnCancelSelection="CancelSelection" />
                }
            </div>
        </div>
    </div>
</div>

<ExaminateModal @ref="examinateModal" CharacterProfile="itemToExamine" OnClose="OnModalClosed" />

@code {
    private ExaminateModal? examinateModal;
    private BaseCharacter? itemToExamine;

    [Parameter]
    public CombatState CombatState { get; set; } = default!;

    private BaseCard? selectedCard;
    private BaseCharacter? hoveredCharacter;
    private bool isPlayerHovered;
    private bool examining = false;
    private DoctorCombatUI? doctorCombatUI;
    private BellRingerCombatUI? bellRingerCombatUI;

    private void OpenExamine(BaseCharacter pessoa)
    {
        itemToExamine = pessoa;
        if (examinateModal != null)
        {
            examinateModal.OpenModal(itemToExamine);
        }
    }

    protected override void OnInitialized()
    {
        CombatState.OnCombatStateChanged += OnCombatStateChanged;
    }

    private void OnCombatStateChanged()
    {
        InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        if (CombatState != null)
        {
            CombatState.OnCombatStateChanged -= OnCombatStateChanged;
        }
    }

    private void CancelSelection()
    {
        selectedCard = null;
        hoveredCharacter = null;
        isPlayerHovered = false;
        examining = false;
        StateHasChanged();
    }

    private void OnModalClosed()
    {
        itemToExamine = null;
        examining = false;
        StateHasChanged();
    }

    private void EndTurnClicked()
    {
        CombatState.EndPlayerTurn();
    }

    private void ExamineClicked()
    {
        examining = !examining;
        StateHasChanged();
    }

    private void SelectCard(BaseCard card)
    {
        selectedCard = card;
        StateHasChanged();
    }

    private void TargetCharacter(BaseCharacter character)
    {
        if (HandleArchetypeTargetSelection(character))
        {
            return;
        }

        if (selectedCard != null)
        {
            CombatState.PlayCard(selectedCard, character);
            selectedCard = null;
            hoveredCharacter = null;
            isPlayerHovered = false;
            StateHasChanged();
        }
        else if (examining)
        {
            itemToExamine = character;
            if (examinateModal != null)
            {
                examinateModal.OpenModal(itemToExamine);
            }
        }
    }

    private void OnArchetypeTargetCharacter(BaseCharacter character)
    {
        HandleArchetypeTargetSelection(character);
    }

    private bool HandleArchetypeTargetSelection(BaseCharacter character)
    {
        if (CombatState.Player is Doctor && doctorCombatUI != null && doctorCombatUI.IsInInfectMode())
        {
            doctorCombatUI.HandleTargetSelection(character);
            return true;
        }
        
        if(CombatState.Player is BellRinger && bellRingerCombatUI != null && bellRingerCombatUI.IsInBellRingMode())
        {
            bellRingerCombatUI.HandleTargetSelection(character);
            return true;
        }
        return false;
    }

    private void OnEnemyHover(BaseCharacter enemy)
    {
        if (selectedCard != null || IsArchetypeAbilityActive())
        {
            hoveredCharacter = enemy;
            StateHasChanged();
        }
    }

    private void OnEnemyOut(BaseCharacter enemy)
    {
        if (hoveredCharacter == enemy)
        {
            hoveredCharacter = null;
            StateHasChanged();
        }
    }

    private void OnPlayerHover()
    {
        if (selectedCard != null || IsArchetypeAbilityActive())
        {
            isPlayerHovered = true;
            StateHasChanged();
        }
    }

    private void OnPlayerOut()
    {
        if (isPlayerHovered)
        {
            isPlayerHovered = false;
            StateHasChanged();
        }
    }

    private void OnAllyHover(BaseCharacter ally)
    {
        if (selectedCard != null || IsArchetypeAbilityActive())
        {
            hoveredCharacter = ally;
            StateHasChanged();
        }
    }

    private void OnAllyOut(BaseCharacter ally)
    {
        if (hoveredCharacter == ally)
        {
            hoveredCharacter = null;
            StateHasChanged();
        }
    }

    private bool IsArchetypeAbilityActive()
    {
        if (CombatState.Player is Doctor && doctorCombatUI != null)
        {
            return doctorCombatUI.IsInInfectMode();
        }
        return false;
    }

    private string GetPlayerCardClass()
    {
        var classes = "player-card";
        if (selectedCard != null || IsArchetypeAbilityActive())
        {
            classes += " selectable";
        }
        if (isPlayerHovered && (selectedCard != null || IsArchetypeAbilityActive()))
        {
            classes += " hovered";
        }
        return classes;
    }

    private string GetAllyCardClass(BaseCharacter ally)
    {
        var classes = "player-card ally-card";
        if (selectedCard != null || IsArchetypeAbilityActive())
        {
            classes += " selectable";
        }
        if (hoveredCharacter == ally && (selectedCard != null || IsArchetypeAbilityActive()))
        {
            classes += " hovered";
        }
        return classes;
    }

    private string GetEnemyCardClass(BaseCharacter enemy)
    {
        var classes = "enemy-card";
        if (selectedCard != null || IsArchetypeAbilityActive())
        {
            classes += " selectable";
        }
        if (hoveredCharacter == enemy && (selectedCard != null || IsArchetypeAbilityActive()))
        {
            classes += " hovered";
        }
        return classes;
    }
}

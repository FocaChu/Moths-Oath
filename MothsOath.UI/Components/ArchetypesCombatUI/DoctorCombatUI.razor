@implements IDisposable
@implements IArchetypeCombatView
@using MothsOath.Core.Entities.Archetypes
@using MothsOath.Core.StatusEffect.DiseaseEffect
@using MothsOath.Core.States
@using MothsOath.Core.Common
@using MothsOath.UI.Interfaces

<button class="archetype-btn btn btn-secondary" @onclick="ShowDisease" @onclick:stopPropagation="true">Exibir Patógeno</button>
<button class="archetype-btn btn btn-danger"
        disabled="@(!CanUseInfectAbility)"
        @onclick="ToggleInfect"
        @onclick:stopPropagation="true">
    Infectar
</button>

<DoctorDiseaseModal @ref="doctorDiseaseModal" />

@code {
    [Parameter] public CombatState CombatState { get; set; } = default!;
    [Parameter] public EventCallback<IArchetypeCombatView> OnRegister { get; set; }
    [Parameter] public Action? OnCancelSelection { get; set; } 

    private DoctorDiseaseModal? doctorDiseaseModal;
    private bool infecting = false;
    private bool abilityUsedThisTurn = false;

    protected override void OnInitialized()
    {
        if (CombatState != null)
        {
            CombatState.OnPlayerTurnStart += ResetAbilityUsage;
        }
        OnRegister.InvokeAsync(this);
    }

    public void Dispose()
    {
        if (CombatState != null)
        {
            CombatState.OnPlayerTurnStart -= ResetAbilityUsage;
        }
    }

    private void ResetAbilityUsage()
    {
        abilityUsedThisTurn = false;
        infecting = false;
        InvokeAsync(StateHasChanged);
    }

    private bool CanUseInfectAbility =>
        CombatState.Player is Doctor doctor &&
        doctor.CurrentMana >= 50 &&
        doctor.Gold >= 10 &&
        !abilityUsedThisTurn;

    private void ShowDisease()
    {
        if (CombatState.Player is Doctor doctor && doctorDiseaseModal != null)
        {
            doctorDiseaseModal.OpenModal(doctor.Disease);
        }
    }

    private void ToggleInfect()
    {
        if (!CanUseInfectAbility) return;
        infecting = !infecting;
        StateHasChanged();
    }


    public bool IsInSpecialMode() => infecting;

    public bool HandleTargetSelection(BaseCharacter target)
    {
        if (!infecting || CombatState.Player is not Doctor doctor)
        {
            return false;
        }

        if (doctor.CurrentMana < 50 || doctor.Gold < 10)
        {
            infecting = false;
            StateHasChanged();
            return false;
        }

        doctor.Infect(target);
        abilityUsedThisTurn = true;
        infecting = false;

        StateHasChanged();
        return true;
    }
}
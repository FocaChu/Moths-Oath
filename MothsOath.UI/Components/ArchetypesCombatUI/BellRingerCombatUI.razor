@implements IDisposable
@using MothsOath.Core.Entities.Archetypes
@using MothsOath.Core.States
@using MothsOath.Core.Common

<div class="bell-ringer-hud">
    <button class="bell-ringer-hud-btn btn btn-primary" 
            disabled="@(!CanUseBellRingAbility)" 
            @onclick="ToggleBellRing" 
            @onclick:stopPropagation="true">Tocar Sino</button>
</div>

@code {
    [Parameter]
    public CombatState CombatState { get; set; } = default!;

    [Parameter]
    public Action<Character>? OnTargetCharacter { get; set; }

    [Parameter]
    public Action? OnCancelSelection { get; set; }

    private bool bellTargeting = false;

    private bool abilityUsedThisTurn = false;

    protected override void OnInitialized()
    {
        if (CombatState != null)
        {
            CombatState.OnPlayerTurnStart += ResetAbilityUsage;
        }
    }

    public void Dispose()
    {
        if (CombatState != null)
        {
            CombatState.OnPlayerTurnStart -= ResetAbilityUsage;
        }
    }

    private void ResetAbilityUsage()
    {
        abilityUsedThisTurn = false;
        InvokeAsync(StateHasChanged);
    }

    private bool CanUseBellRingAbility => 
        CombatState.Player is BellRinger &&
        CombatState.Player.CurrentMana >= 40 &&
        !abilityUsedThisTurn;

    private void ToggleBellRing()
    {
        if (!CanUseBellRingAbility)
        {
            return;
        }

        bellTargeting = !bellTargeting;
        StateHasChanged();
    }

    public void HandleTargetSelection(Character target)
    {
        if (!CanUseBellRingAbility || CombatState.Player is not BellRinger bellRinger || target is Player)
        {
            return;
        }

        if(bellRinger.CurrentMana < 40)
        {
            return;
        }

        bellRinger.BellRingAbility(CombatState, target);
        abilityUsedThisTurn = true;
        bellTargeting = false;

        StateHasChanged();
    }


    public bool IsInBellRingMode() => bellTargeting;
}
